<!doctypehtml><title>Hydration failed - React Encoder Error | vespaiach.com</title><meta content=width=device-width,initial-scale=1 name=viewport><meta content="Sometimes, it’s quite annoying to encounter a hydration failed error in ReactJS but the error is not obvious to figure out. Here are my experiences about how I fixed that error in my web application written by NextJS/ReactJS." name=description><meta content=javascript,date,nextjs,reactjs name=keywords><meta content="index, nofollow" name=robots><meta content="Hydration failed - React Encoder Error" property=og:title><meta content="Sometimes, it’s quite annoying to encounter a hydration failed error in ReactJS but the error is not obvious to figure out. Here are my experiences about how I fixed that error in my web application written by NextJS/ReactJS." property=og:description><meta content=article property=og:type><meta content=https://www.vespaiach.com/hydration-failed-react-encoder-error.html property=og:url><meta content=https://www.vespaiach.com/images/hydration-failed-react-encoder-error.jpeg property=og:image><meta content="Hydration failed - React Encoder Error" property=og:image:alt><link href=https://www.vespaiach.com/hydration-failed-react-encoder-error.html rel=canonical><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href=https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;500;600;700&display=swap rel=stylesheet><link href=/css/post-a313df4414b87d724cd9c5e4584c1968.css rel=stylesheet><script src=/js/post-f902d7e0a2e9254a4bede1132a14fd27.js></script><script type=application/ld+json>{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.vespaiach.com/hydration-failed-react-encoder-error.html"
  },
  "headline": "Hydration failed - React Encoder Error",
  "description": "Sometimes, it’s quite annoying to encounter a hydration failed error in ReactJS but the error is not obvious to figure out. Here are my experiences about how I fixed that error in my web application written by NextJS/ReactJS.",
  "image": `https://www.vespaiach.com/hydration-failed-react-encoder-error.jpeg`,
  "datePublished": "Wednesday, June 22, 2022",
  "dateModified": "Wednesday, June 22, 2022",
  "author": {
    "@type": "Person",
    "name": "Trinh Nguyen (vespaiach)"
  },
  "publisher": {
    "@type": "Person Blog",
    "name": "vespaich.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.vespaiach.com/favicon.ico",
    }
  },
  "articleBody": "&lt;h2&gt;Error description&lt;/h2&gt;
&lt;p&gt;After adding dark mode support to my website, I deployed it to production and got back these error:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://reactjs.org/docs/error-decoder.html/?invariant=425&quot;&gt;https://reactjs.org/docs/error-decoder.html/?invariant=425&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://reactjs.org/docs/error-decoder.html/?invariant=418&quot;&gt;https://reactjs.org/docs/error-decoder.html/?invariant=418&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;More often, it wouldn’t be difficult to find out the root cause might be that some of my codes had access to DOM while the website was in server-side rendering (SSR) progress. For instance, in my case, there might be a call to &lt;code&gt;window.localstorage&lt;/code&gt; to get dark mode preference while the app was in SSR, and the result would be the miss-match HTML rendering between server response and client rendering, just because window object was undefined in server-side.&lt;/p&gt;
&lt;p&gt;However, it wasn’t the case for me, I had carefully added a check &lt;code&gt;typeof window === ‘undefined’&lt;/code&gt; before accessing localstorage to make sure the code was run in the browser environment…And it took me quite a while to figure out the root cause of HTML mis-match was in the data that was used to render HTML code in SSR and the data that was sent to the client for rendering.&lt;/p&gt;
&lt;h2&gt;The error&lt;/h2&gt;
&lt;p&gt;In my website, I previously sorted articles by alphabet. Then, I changed to sort them by date, and dates were stored as string, so I converted date strings into Date objects (JS), sorted them, serialized them  and returned them to client-side - note that NextJS does not serialize Date objects for us by default, this library &lt;a href=&quot;https://www.npmjs.com/package/babel-plugin-superjson-next&quot;&gt;superjson-next&lt;/a&gt; will help to do that. Read &lt;a href=&quot;https://github.com/vercel/next.js/issues/13209#issuecomment-633149650&quot;&gt;this thread&lt;/a&gt; to see why NextJS fails to serialize Date objects.&lt;/p&gt;
&lt;p&gt;The problem came from how browsers parse date string format into Date objects. For example, in data send to client, I have a date string in ISO format &lt;code&gt;2022-06-20T00:00:00.000Z&lt;/code&gt;, that was date in UTC time, but when my browser parsed that date string, it automatically converted the date into local offset, and for me that was June 19th in Eastern Time.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.vespaiach.com/images/browser_date_parse.gif&quot; alt=&quot;Date parsing&quot;&gt;&lt;/p&gt;
&lt;p&gt;And here was the mis-match data that caused the hydration error in React-DOM.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.vespaiach.com/images/err_418.png&quot; alt=&quot;Error 418&quot;&gt;&lt;/p&gt;
&lt;h2&gt;The fix&lt;/h2&gt;
&lt;p&gt;Since I just want to display dates and don’t care about time, I updated my code to format date string on server-side, on client-side just simply use that string format for displaying, and there was no datetime converting on client-side anymore.&lt;/p&gt;
&lt;h2&gt;Lessons Learned&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Despite the fact that the Date object in Javascript is using UTC time to calculate its value, the way browsers parse Date objects always include local timezone and offset.&lt;/li&gt;
&lt;li&gt;In the NodeJS environment, the Date object is always UTC time. When we enter different time zones, NodeJS will convert to UTC time.&lt;/li&gt;
&lt;/ul&gt;
",
  "keywords": "javascript,date,nextjs,reactjs"
}</script><body style="background: white;"><div class=i-am-top id=top></div><div class=home><a title="Home page" href=/>home</a></div><article class=article><div class=meta><div class=meta-item><svg viewbox="0 0 448 512" height=1em xmlns=http://www.w3.org/2000/svg><path d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM48 192H400V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192z"></path></svg><span data-date="Wednesday, June 22, 2022" class=date>Wednesday, June 22, 2022</span></div><a class="last link-svg" rel="noopener noreferrer" href=https://github.com/vespaiach/personal_website/blob/main/docs/hydration-failed-react-encoder-error.md target=_blank><svg viewbox="0 0 496 512" height=1em xmlns=http://www.w3.org/2000/svg><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div><div class=content><h1 class=title>Hydration failed - React Encoder Error</h1><h2>Error description</h2><p>After adding dark mode support to my website, I deployed it to production and got back these error:<ul><li><a href=https://reactjs.org/docs/error-decoder.html/?invariant=425>https://reactjs.org/docs/error-decoder.html/?invariant=425</a><li><a href=https://reactjs.org/docs/error-decoder.html/?invariant=418>https://reactjs.org/docs/error-decoder.html/?invariant=418</a></ul><p>More often, it wouldn’t be difficult to find out the root cause might be that some of my codes had access to DOM while the website was in server-side rendering (SSR) progress. For instance, in my case, there might be a call to <code>window.localstorage</code> to get dark mode preference while the app was in SSR, and the result would be the miss-match HTML rendering between server response and client rendering, just because window object was undefined in server-side.<p>However, it wasn’t the case for me, I had carefully added a check <code>typeof window === ‘undefined’</code> before accessing localstorage to make sure the code was run in the browser environment…And it took me quite a while to figure out the root cause of HTML mis-match was in the data that was used to render HTML code in SSR and the data that was sent to the client for rendering.<h2>The error</h2><p>In my website, I previously sorted articles by alphabet. Then, I changed to sort them by date, and dates were stored as string, so I converted date strings into Date objects (JS), sorted them, serialized them and returned them to client-side - note that NextJS does not serialize Date objects for us by default, this library <a href=https://www.npmjs.com/package/babel-plugin-superjson-next>superjson-next</a> will help to do that. Read <a href=https://github.com/vercel/next.js/issues/13209#issuecomment-633149650>this thread</a> to see why NextJS fails to serialize Date objects.<p>The problem came from how browsers parse date string format into Date objects. For example, in data send to client, I have a date string in ISO format <code>2022-06-20T00:00:00.000Z</code>, that was date in UTC time, but when my browser parsed that date string, it automatically converted the date into local offset, and for me that was June 19th in Eastern Time.<p><img alt="Date parsing" src=https://www.vespaiach.com/images/browser_date_parse.gif><p>And here was the mis-match data that caused the hydration error in React-DOM.<p><img alt="Error 418" src=https://www.vespaiach.com/images/err_418.png><h2>The fix</h2><p>Since I just want to display dates and don’t care about time, I updated my code to format date string on server-side, on client-side just simply use that string format for displaying, and there was no datetime converting on client-side anymore.<h2>Lessons Learned</h2><ul><li>Despite the fact that the Date object in Javascript is using UTC time to calculate its value, the way browsers parse Date objects always include local timezone and offset.<li>In the NodeJS environment, the Date object is always UTC time. When we enter different time zones, NodeJS will convert to UTC time.</ul></div></article><footer><div class=footer><a href=https://www.linkedin.com/in/trinh-nguyen-0a701526><svg viewbox="0 0 448 512" height=1em xmlns=http://www.w3.org/2000/svg><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg></a><a href=https://github.com/vespaiach><svg viewbox="0 0 480 512" height=1em xmlns=http://www.w3.org/2000/svg><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z">a(class="back-to-top", href="#top") top</path></svg></a></div></footer><a class=back-to-top href=#top>top</a>